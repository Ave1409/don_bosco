<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Petal Safe</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('https://media.istockphoto.com/id/1382596550/vector/abstract-art-pink-floral-background-hand-draw-outline-flowers-magnolia-sketch-with-leaves.jpg?s=612x612&w=0&k=20&c=d4TLUvB16PCF1afgwPsDhcZFKtuZ3VAFKkvzpNchP5c=');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      min-height: 100vh;
      /* Subtle fade-in */
      animation: fadeInBody 1.2s cubic-bezier(.4, 2, .6, 1);
    }

    @keyframes fadeInBody {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 28px;
      background: rgba(255, 240, 246, 0.85);
      border-bottom: 1px solid #ffd6e7;
      background-image: url('https://www.transparenttextures.com/patterns/flowers.png');
      box-shadow: 0 8px 32px rgba(214, 51, 132, 0.08);
      backdrop-filter: blur(8px);
      border-radius: 0 0 24px 24px;
      transition: background 0.4s, box-shadow 0.4s;
    }

    nav:hover {
      background: rgba(255, 240, 246, 0.95);
      box-shadow: 0 12px 40px rgba(214, 51, 132, 0.13);
    }

    .logo-title {
      display: flex;
      align-items: center;
    }

    .logo-title img {
      width: 48px;
      height: 48px;
      margin-right: 14px;
      filter: drop-shadow(0 2px 8px #ffd6e7);
      transition: transform 0.3s;
    }

    .logo-title img:hover {
      transform: scale(1.12) rotate(-8deg);
    }

    .logo-title span {
      font-size: 28px;
      font-weight: bold;
      color: #d63384;
      letter-spacing: 2px;
      text-shadow: 0 2px 8px #ffd6e7;
      transition: color 0.3s;
    }

    .logo-title span:hover {
      color: #ad1457;
    }

    .nav-links a {
      margin-left: 24px;
      text-decoration: none;
      font-size: 22px;
      color: #d63384;
      font-weight: bold;
      padding: 8px 18px;
      border-radius: 8px;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
    }

    .nav-links a:hover {
      color: #fff;
      background: linear-gradient(90deg, #ffb6d5 0%, #d63384 100%);
      box-shadow: 0 2px 12px #ffd6e7;
    }

    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 64px);
      animation: fadeInCenter 1.2s 0.2s cubic-bezier(.4, 2, .6, 1) backwards;
      position: relative;
      
    }  

    .circle-button {
      width: 50vh;
      height: 50vh;
      border-radius: 50%;
      background: none;
      border: 5px dashed #ff69b4;
      padding: 0;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(214, 51, 132, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
      backdrop-filter: blur(2px);
      background: rgba(255, 255, 255, 0.12);
      left: 55px;   
      position: relative;
    }

    .circle-button:hover {
      border-color: #ff1493;
      box-shadow: 0 12px 40px #ffd6e7;
      transform: scale(1.04) rotate(-2deg);
    }

    .side-panels {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100vh;
      height: 100vh;
      transform: translate(-50%, -50%);
      /* pointer-events: auto; not needed here, let children handle it */
    }
    

    .panel-icon {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      color: #d63384;
      font-size: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(214, 51, 132, 0.15);
      transition: transform 0.3s, background 0.3s, box-shadow 0.3s, filter 0.3s;
      pointer-events: auto;
      backdrop-filter: blur(4px);
      animation: fadeInPanel 1.2s ease;
      cursor: pointer;
      outline: none;
    }

    .panel-icon.radial {
  transform-origin: center;
}
.panel-icon.radial {
  transform: rotate(calc(36deg * var(--i))) translate(35vh) rotate(calc(-36deg * var(--i)));
}

.panel-icon.radial:hover {
  transform: rotate(calc(36deg * var(--i))) translate(35vh) rotate(calc(-36deg * var(--i))) scale(1.12);
}

    @keyframes fadeInPanel {
      from {
        opacity: 0;
        transform: scale(0.5);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  .panel-icon div {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .panel-icon span {
      font-size: 14px;
      font-weight: 600;
      color: #c83282;
      margin-top: 6px;
    }



    /* Radial positioning - use a separate class so transform can be composed with hover */
    .panel-icon {
      /* ...existing styles... */
      top: 50%;
      left: 50%;
    }
    .panel-icon.radial {
      transform: rotate(calc(36deg * var(--i))) translate(35vh) rotate(calc(-36deg * var(--i)));
    }

    .circle-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
      filter: drop-shadow(0 2px 12px #ffd6e7);
      transition: filter 0.3s, transform 0.3s;
    }

    .circle-button:hover .circle-img {
      filter: drop-shadow(0 4px 24px #ffb6d5);
      transform: scale(1.06);
    }

    .abort-button {
      margin-top: 20px;
      padding: 12px 28px;
      border-radius: 999px;
      background: linear-gradient(90deg, #d63384 0%, #ffb6d5 100%);
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 12px #ffd6e7;
      font-weight: bold;
      letter-spacing: 1px;
      transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
    }

    .abort-button:hover {
      background: linear-gradient(90deg, #ad1457 0%, #ffb6d5 100%);
      box-shadow: 0 4px 24px #ffb6d5;
      transform: scale(1.05);
    }

    .send-help-button {
      margin-top: 20px;
      padding: 24px 48px;
      border-radius: 999px;
      background: linear-gradient(90deg, #d63384 0%, #ffb6d5 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 2px 12px #ffd6e7;
      font-weight: bold;
      letter-spacing: 1px;
      transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
    }

    .send-help-button:hover {
      background: linear-gradient(90deg, #ad1457 0%, #ffb6d5 100%);
      box-shadow: 0 4px 24px #ffb6d5;
      transform: scale(1.07) rotate(-2deg);
    }

    
  </style>
</head>
<body>
  <nav>
    <div class="logo-title">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <span>Petals</span>
    </div>
    <div class="nav-links">
      <a href="{{ url_for('register') }}">Register</a>
      <a href="{{ url_for('login') }}">Login</a>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>
  </nav>

  <div class="center">
    <button id="rescueButton" class="circle-button">
      <img src="{{ url_for('static', filename='button.png') }}" alt="Rescue" class="circle-img" />
    </button>
    <button id="abortButton" class="abort-button" style="display:none;">Abort</button>
    <button id="helpButton" class="send-help-button" style="display:none;">Send Help</button>
  </div>

  <div class="flower-banner"></div>

  <!-- Socket.IO client library (must be before your script) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
        // ---- BEGINNING OF SCRIPT ----

    // User authentication/session ID from your backend; this must be set securely!
    const USER_ID_FROM_APP = "{{ user_id|safe }}"; 

    let socket;
    let mediaRecorder = null;
    let audioStream = null;
    let animationFrameId = null;
    let lastHighSoundTime = 0;
    let dangerState = { highest_audio: "Low", dispatch: false };

    const rescueButton = document.getElementById("rescueButton");
    const abortButton = document.getElementById("abortButton");
    const helpButton = document.getElementById("helpButton");

    // ------ SOCKET.IO CONNECTION ------

    function connectSocket() {
        socket = io('http://localhost:5000'); // Assign to the global 'socket' variable

        function sendLocation() {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            socket.emit('client_location', { user_id: USER_ID_FROM_APP, lat, lon });
          }, function(err) {
            console.log("Location error", err);
          });
        }
      }

        // Call once after socket connect:
        socket.on('connect', function() {
            if (USER_ID_FROM_APP) socket.emit('connect_user', { user_id: USER_ID_FROM_APP });
            sendLocation(); // Send initial location
        });

        // Optionally, send regularly for updates:
        setInterval(sendLocation, 10000); // every 10 seconds


        socket.on('disconnect', function () {
            console.log("Socket disconnected.");
        });

        // Optionally respond to server or admin messages here (e.g., panic ack)
        socket.on('panic_ack', function (msg) {
            alert('Panic acknowledged by authorities!');
        });
    }

    connectSocket();


    // ------ AUDIO STREAMING & DETECTION ------

    function startAudioStream() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                audioStream = stream;
                
                // UI & state updates
                document.body.style.background = "#ffe4ec";
                rescueButton.style.display = "none";
                abortButton.style.display = "inline-block";
                dangerState = { highest_audio: "Low", dispatch: false };

                // --- Live VOLUME DETECTION ---
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                source.connect(analyser);
                analyser.fftSize = 512;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                function checkVolume() {
                    analyser.getByteFrequencyData(dataArray);
                    const maxVal = Math.max(...dataArray);
                    const now = Date.now();

                    if (maxVal > 225) { // DANGER
                        lastHighSoundTime = now;
                        dangerState.highest_audio = "Danger";
                        document.body.style.background = "#ffcccc";
                        helpButton.style.display = "inline-block";
                        if (!dangerState.dispatch) {
                            dangerState.dispatch = true;
                            socket.emit('panic', { user_id: USER_ID_FROM_APP, level: "Danger" });
                        }
                    } else if (maxVal > 50) { // MEDIUM
                        dangerState.highest_audio = "Medium";
                        document.body.style.background = "#ffe6e6";
                    } else { // LOW
                        dangerState.highest_audio = "Low";
                        document.body.style.background = "#fff0f6";
                    }

                    if (now - lastHighSoundTime > 10000) helpButton.style.display = "none";

                    animationFrameId = requestAnimationFrame(checkVolume);
                }
                checkVolume();

                // --- MediaRecorder: For streaming audio chunks via socket ---
                let mimeType = 'audio/webm; codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = '';

                mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

                mediaRecorder.ondataavailable = function (event) {
                    if (event.data && event.data.size > 0) {
                        let reader = new FileReader();
                        reader.onloadend = function () {
                            // send audio chunk (as base64, minus prefix) to server
                            socket.emit('audio_chunk', {
                                user_id: USER_ID_FROM_APP,
                                chunk: reader.result.split(',')[1]
                            });
                        };
                        reader.readAsDataURL(event.data);
                    }
                };

                // Send a chunk every 250 ms
                mediaRecorder.start(250);

            })
            .catch(function (err) {
                alert("Microphone access denied. Please grant access on a secure connection (HTTPS or localhost).");
                resetUI();
            });
    }

    function stopAudioStream(sendFinalBlob = true) {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            // If sendFinalBlob: capture last data for disk upload, else stop gracefully for socket
            if (sendFinalBlob) {
                // Collect and upload the final audio (for disk/case evidence, as in your original)
                const chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
                    const formData = new FormData();
                    const fileExt = mediaRecorder.mimeType.split('/')[1].split(';')[0];
                    formData.append("audio", blob, `recording.${fileExt}`);
                    fetch("/api/upload-audio", { method: "POST", body: formData });
                };
            }
            mediaRecorder.stop();
        }

        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    // --- Button/UI management ---
    function resetUI() {
        document.body.style.background = "linear-gradient(135deg, #ffe6f0, #fcd3e1)";
        rescueButton.style.display = "inline-block";
        abortButton.style.display = "none";
        helpButton.style.display = "none";
        helpButton.innerText = "Send Help";
        helpButton.disabled = false;
        dangerState = { highest_audio: "Low", dispatch: false };
        lastHighSoundTime = 0;
    }


    // ------ UI BUTTON EVENTS ------

    rescueButton.addEventListener("click", function () {
        socket.emit('send_rescue', { data: "Rescue sequence initiated" });
        startAudioStream();
    });

    abortButton.addEventListener("click", function () {
        socket.emit('send_safe', { data: "Rescue aborted by user" });
        stopAudioStream();
        resetUI();
    });

    helpButton.addEventListener("click", function () {
        socket.emit('send_help', { message: "Help button manually triggered due to high volume." });
        helpButton.innerText = "Help Sent!";
        helpButton.disabled = true;
        stopAudioStream();
        // Reset after short delay
        setTimeout(() => {
            abortButton.click();
        }, 2000);
    });


    window.addEventListener("beforeunload", (event) => {
  // Only emit if recording is active and panic not already triggered
      if (mediaRecorder && mediaRecorder.state === "recording") {
        socket.emit('auto_dispatch', { user_id: USER_ID_FROM_APP });
        // Optionally block unload to give time to submit (not recommended due to UX)
        // event.preventDefault();
        // event.returnValue = '';
      }
    });



    // ---- END OF SCRIPT ----

  </script>
</body>
</html>