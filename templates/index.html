<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Petal Safe</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ffe6f0, #fcd3e1);
      transition: background-color 0.3s ease;
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 28px;
      background-color: #fff0f6;
      border-bottom: 1px solid #ffd6e7;
      background-image: url('https://www.transparenttextures.com/patterns/flowers.png');
    }
    .logo-title {
      display: flex;
      align-items: center;
    }
    .logo-title img {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .logo-title span {
      font-size: 24px;
      font-weight: bold;
      color: #d63384;
    }
    .nav-links a {
      margin-left: 20px;
      text-decoration: none;
      font-size: 20px;
      color: #d63384;
      font-weight: bold;
    }
    .nav-links a:hover {
      color: #ad1457;
    }
    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 64px);
    }
    .circle-button {
      width: 50vh;
      height: 50vh;
      border-radius: 50%;
      background-color: #ff69b4;
      color: white;
      font-size: 60px;
      border: 5px dashed white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      background-image: url('https://www.transparenttextures.com/patterns/flower-pattern.png');
    }
    .circle-button:hover {
      background-color: #ff1493;
    }
    .abort-button {
      margin-top: 20px;
      padding: 10px 20px;
      border-radius: 999px;
      background-color: #d63384;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .abort-button:hover {
      background-color: #ad1457;
    }
    .send-help-button {
      margin-top: 20px;
      padding: 24px 48px;
      border-radius: 999px;
      background-color: #d63384;
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: background 0.2s, transform 0.2s;
    }
    .send-help-button:hover {
      background-color: #ad1457;
      transform: scale(1.05);
    }
    .flower-banner {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 100px;
      background-image: url('https://www.transparenttextures.com/patterns/flowertrail.png');
      background-size: cover;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo-title">
      <img src="logo.png" alt="Logo" />
      <span>Petals</span>
    </div>
    <div class="nav-links">
      <a href="/register.html">Register</a>
      <a href="/login.html">Login</a>
      <a href="/dashboard.html">Dashboard</a>
    </div>
  </nav>

  <div class="center">
    <button id="rescueButton" class="circle-button">ðŸ’®</button>
    <button id="abortButton" class="abort-button" style="display:none;">Abort</button>
    <button id="helpButton" class="send-help-button" style="display:none;">Send Help</button>
  </div>

  <div class="flower-banner"></div>

  <!-- Socket.IO client library (must be before your script) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
        // ---- BEGINNING OF SCRIPT ----

    // User authentication/session ID from your backend; this must be set securely!
    const USER_ID_FROM_APP = "{{ user_id|safe }}"; 

    let socket;
    let mediaRecorder = null;
    let audioStream = null;
    let animationFrameId = null;
    let lastHighSoundTime = 0;
    let dangerState = { highest_audio: "Low", dispatch: false };

    const rescueButton = document.getElementById("rescueButton");
    const abortButton = document.getElementById("abortButton");
    const helpButton = document.getElementById("helpButton");

    // ------ SOCKET.IO CONNECTION ------

    function connectSocket() {
        socket = io('http://localhost:5000'); // Assign to the global 'socket' variable

        socket.on('connect', function() {
            // Notify server & join user-specific room
            if (USER_ID_FROM_APP) socket.emit('connect_user', { user_id: USER_ID_FROM_APP });
        });

        socket.on('disconnect', function () {
            console.log("Socket disconnected.");
        });

        // Optionally respond to server or admin messages here (e.g., panic ack)
        socket.on('panic_ack', function (msg) {
            alert('Panic acknowledged by authorities!');
        });
    }

    connectSocket();


    // ------ AUDIO STREAMING & DETECTION ------

    function startAudioStream() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                audioStream = stream;
                
                // UI & state updates
                document.body.style.background = "#ffe4ec";
                rescueButton.style.display = "none";
                abortButton.style.display = "inline-block";
                dangerState = { highest_audio: "Low", dispatch: false };

                // --- Live VOLUME DETECTION ---
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                source.connect(analyser);
                analyser.fftSize = 512;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                function checkVolume() {
                    analyser.getByteFrequencyData(dataArray);
                    const maxVal = Math.max(...dataArray);
                    const now = Date.now();

                    if (maxVal > 225) { // DANGER
                        lastHighSoundTime = now;
                        dangerState.highest_audio = "Danger";
                        document.body.style.background = "#ffcccc";
                        helpButton.style.display = "inline-block";
                        if (!dangerState.dispatch) {
                            dangerState.dispatch = true;
                            socket.emit('auto_dispatch', { status: "auto-dispatch", level: dangerState.highest_audio });
                        }
                    } else if (maxVal > 50) { // MEDIUM
                        dangerState.highest_audio = "Medium";
                        document.body.style.background = "#ffe6e6";
                    } else { // LOW
                        dangerState.highest_audio = "Low";
                        document.body.style.background = "#fff0f6";
                    }

                    if (now - lastHighSoundTime > 10000) helpButton.style.display = "none";

                    animationFrameId = requestAnimationFrame(checkVolume);
                }
                checkVolume();

                // --- MediaRecorder: For streaming audio chunks via socket ---
                let mimeType = 'audio/webm; codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = '';

                mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

                mediaRecorder.ondataavailable = function (event) {
                    if (event.data && event.data.size > 0) {
                        let reader = new FileReader();
                        reader.onloadend = function () {
                            // send audio chunk (as base64, minus prefix) to server
                            socket.emit('audio_chunk', {
                                user_id: USER_ID_FROM_APP,
                                chunk: reader.result.split(',')[1]
                            });
                        };
                        reader.readAsDataURL(event.data);
                    }
                };

                // Send a chunk every second (1000 ms)
                mediaRecorder.start(1000);

            })
            .catch(function (err) {
                alert("Microphone access denied. Please grant access on a secure connection (HTTPS or localhost).");
                resetUI();
            });
    }

    function stopAudioStream(sendFinalBlob = true) {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            // If sendFinalBlob: capture last data for disk upload, else stop gracefully for socket
            if (sendFinalBlob) {
                // Collect and upload the final audio (for disk/case evidence, as in your original)
                const chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
                    const formData = new FormData();
                    const fileExt = mediaRecorder.mimeType.split('/')[1].split(';')[0];
                    formData.append("audio", blob, `recording.${fileExt}`);
                    fetch("/api/upload-audio", { method: "POST", body: formData });
                };
            }
            mediaRecorder.stop();
        }

        if (audioStream) {
            audioStream.getTracks().forEach(track => track.stop());
            audioStream = null;
        }
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    // --- Button/UI management ---
    function resetUI() {
        document.body.style.background = "linear-gradient(135deg, #ffe6f0, #fcd3e1)";
        rescueButton.style.display = "inline-block";
        abortButton.style.display = "none";
        helpButton.style.display = "none";
        helpButton.innerText = "Send Help";
        helpButton.disabled = false;
        dangerState = { highest_audio: "Low", dispatch: false };
        lastHighSoundTime = 0;
    }


    // ------ UI BUTTON EVENTS ------

    rescueButton.addEventListener("click", function () {
        socket.emit('send_rescue', { data: "Rescue sequence initiated" });
        startAudioStream();
    });

    abortButton.addEventListener("click", function () {
        socket.emit('send_safe', { data: "Rescue aborted by user" });
        stopAudioStream();
        resetUI();
    });

    helpButton.addEventListener("click", function () {
        socket.emit('send_help', { message: "Help button manually triggered due to high volume." });
        helpButton.innerText = "Help Sent!";
        helpButton.disabled = true;
        stopAudioStream();
        // Reset after short delay
        setTimeout(() => {
            abortButton.click();
        }, 2000);
    });

    // Optional: detect sudden tab closure (could mean distress, trigger panic)
    // Not possible to reliably send a socket event before browser unloads, but you may attempt:
    window.addEventListener("beforeunload", (e) => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            // Attempt to notify server
            socket.emit('panic', { user_id: USER_ID_FROM_APP });
        }
    });


    // ---- END OF SCRIPT ----

  </script>
</body>
</html>